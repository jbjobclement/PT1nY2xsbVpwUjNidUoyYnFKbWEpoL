"use strict";(self.webpackChunkJBNotifier=self.webpackChunkJBNotifier||[]).push([[53620],{53620:(H,f,s)=>{s.r(f),s.d(f,{NotificationSettingsModule:()=>Q});var m=s(96814),v=s(31610),c=s(88762),u=s(23758);const C={index:"",get:"",create:"",update:"",delete:""},x=[{dataField:"creatorId",path:"",pathForSelectedDisplay:""},{dataField:"lastModifierId",path:"",pathForSelectedDisplay:""},{dataField:"notificationSettingDefinitionId",path:"",pathForSelectedDisplay:""}],I=[{dataField:"id",translateKeys:["Id"]},{dataField:"creationTime",translateKeys:["CreationTime"]},{dataField:"creatorId",translateKeys:["CreatorId"]},{name:"creatorCode",translateKeys:["CreatorId"]},{name:"creatorName",translateKeys:["CreatorId"]},{dataField:"lastModificationTime",translateKeys:["LastModificationTime"]},{dataField:"lastModifierId",translateKeys:["LastModifierId"]},{name:"lastModifierCode",translateKeys:["LastModifierId"]},{name:"lastModifierName",translateKeys:["LastModifierId"]},{dataField:"value",translateKeys:["Value"]},{dataField:"isInherited",translateKeys:["IsInherited"]},{dataField:"notificationSettingDefinitionId",translateKeys:["NotificationSettingDefinitionId"]},{name:"notificationSettingDefinitionCode",translateKeys:["NotificationSettingDefinitionId"]},{name:"notificationSettingDefinitionName",translateKeys:["NotificationSettingDefinitionId"]},{dataField:"concurrencyStamp",translateKeys:["ConcurrencyStamp"]}],D=[{dataField:"id",mapping:["id"]},{dataField:"concurrencyStamp",mapping:["concurrencyStamp"]},{dataField:"id",queryStringKey:"Id",mapping:["id"]},{dataField:"creationTime",queryStringKey:"CreationTime",mapping:["creationTime"]},{dataField:"creatorId",queryStringKey:"CreatorId",mapping:["creatorId"]},{name:"creatorCode",queryStringKey:"CreatorId",mapping:["creator"]},{name:"creatorName",queryStringKey:"CreatorId",mapping:["creator"]},{dataField:"lastModificationTime",queryStringKey:"LastModificationTime",mapping:["lastModificationTime"]},{dataField:"lastModifierId",queryStringKey:"LastModifierId",mapping:["lastModifierId"]},{name:"lastModifierCode",queryStringKey:"LastModifierId",mapping:["lastModifier"]},{name:"lastModifierName",queryStringKey:"LastModifierId",mapping:["lastModifier"]},{dataField:"value",queryStringKey:"Value",mapping:["value"]},{dataField:"isInherited",queryStringKey:"IsInherited",mapping:["isInherited"]},{dataField:"notificationSettingDefinitionId",queryStringKey:"NotificationSettingDefinitionId",mapping:["notificationSettingDefinitionId"]},{name:"notificationSettingDefinitionCode",queryStringKey:"NotificationSettingDefinitionId",mapping:["notificationSettingDefinition"]},{name:"notificationSettingDefinitionName",queryStringKey:"NotificationSettingDefinitionId",mapping:["notificationSettingDefinition"]},{dataField:"concurrencyStamp",queryStringKey:"ConcurrencyStamp",mapping:["concurrencyStamp"]}],F=[{dataField:"items",template:"notification-setting-definition",label:{visible:!1}}];var T=s(37398),g=s(99397),h=s(94664),p=s(6990),t=s(19212),M=s(53009),K=s(24270);const S={labelLocation:"top",showColonAfterLabel:!1};var y=s(609),N=s(10829);let L=(()=>{class o{constructor(i,n,a){this.form=i,this.localization=n,this.lookupDataSourceService=a,this.editorOptionPreProcess=e=>{"dxSelectBox"===e.editorType&&(e.editorOptions={...e.editorOptions}),"dxDateBox"===e.editorType&&(e.editorOptions={...e.editorOptions})};for(const e in S)this.form[e]=S[e];this.form.customizeItem=e=>{this.formDataFieldLocalization(e),this.editorOptionPreProcess(e),this.patchLookupDataSource(e)}}ngOnInit(){this.lang=this.localization.currentLang,this.isChinese=!!this.lang.includes("zh"),this.formProperties&&Object.keys(this.formProperties).forEach(n=>{this.form[n]=this.formProperties[n]}),this.form.instance.on("initialized",i=>{const n=this.form.instance.option("items"),a=(0,p.cloneDeep)(n);this.form.instance.option("items",a),this.formItemLocalization(i)})}formDataFieldLocalization(i){const n=i.dataField,a=this.dataFieldTranslationKeysMapping?.find(e=>e.dataField===n)?.translateKeys;if(a){const r=a.map(d=>this.localization.instant(`HRM::${d}`))?.join(this.isChinese?"":" ");i.label={...i.label,text:r},i.title=r,i.caption=r}i.validationRules?.forEach(e=>{e.message=this.localization.instant(e.message)})}formItemLocalization(i){this.formItemTranslationMapping?.forEach(n=>{const e=n.translateKeys.map(r=>this.localization.instant(`HRM::${r}`))?.join(this.isChinese?"":" ");i.component.instance().itemOption(n.itemPath,{title:e,caption:e})})}patchLookupDataSource(i){const n=this.dataFieldLookUpSourceMapping?.find(a=>a.dataField===i.dataField);if(n){const a=this.lookupDataSourceService.getLookupDataSource(n);i.editorOptions={...i.editorOptions,dataSource:a}}}static#t=this.\u0275fac=function(n){return new(n||o)(t.Y36(y.Y),t.Y36(c.oQ8),t.Y36(N.V))};static#i=this.\u0275dir=t.lG2({type:o,selectors:[["","appFormFeature",""]],inputs:{dataFieldLookUpSourceMapping:"dataFieldLookUpSourceMapping",formItemTranslationMapping:"formItemTranslationMapping",dataFieldTranslationKeysMapping:"dataFieldTranslationKeysMapping",formProperties:"formProperties"},standalone:!0})}return o})();var b=s(16358),A=s(20843),_=s(10518),Z=s(74291);const z=["grid"];function J(o,l){if(1&o){const i=t.EpF();t.TgZ(0,"div")(1,"dx-select-box",9),t.NdJ("valueChange",function(a){t.CHM(i);const e=t.oxw();return t.KtG(e.formData.tenantId=a)})("onValueChanged",function(a){t.CHM(i);const e=t.oxw();return t.KtG(e.onTenantChanged(a))}),t.qZA()()}if(2&o){const i=t.oxw();t.xp6(),t.Q6J("dataSource",i.tenantsDataSource)("value",i.formData.tenantId)}}const U=(o,l)=>l.id;function P(o,l){if(1&o){const i=t.EpF();t.TgZ(0,"div",10)(1,"div",11),t._uU(2),t.qZA(),t.TgZ(3,"div",12)(4,"dx-text-box",13),t.NdJ("valueChange",function(a){const r=t.CHM(i).$implicit;return t.KtG(r.value=a)})("onValueChanged",function(a){t.CHM(i);const e=t.oxw(2);return t.KtG(e.onSettingValueChanged(a))}),t.qZA()(),t.TgZ(5,"div")(6,"dx-button",14),t.NdJ("onClick",function(){const e=t.CHM(i).$implicit;return t.KtG(e.value=e.defaultValue)}),t.ALo(7,"abpLocalization"),t.qZA()()()}if(2&o){const i=l.$implicit;t.xp6(2),t.hij(" ",i.displayName," "),t.xp6(2),t.Q6J("value",i.value),t.xp6(2),t.Q6J("text",t.lcZ(7,3,"::\u9084\u539f\u9810\u8a2d\u503c"))}}function O(o,l){if(1&o&&(t.TgZ(0,"div"),t.SjG(1,P,8,5,"div",15,U),t.qZA()),2&o){const i=t.oxw();t.xp6(),t.wJu(i.formData.items)}}const V=[{path:"",component:(()=>{class o{constructor(i,n,a){this.appRestService=i,this.configStateService=n,this.toastService=a,this.cRUDEndpoints=C,this.dataFieldLookupSourceMapping=x,this.dataFieldTranslationKeysMapping=I,this.relatedDataValueAndQueryStringKeyMapping=D,this.formItems=F,this.formData={tenantId:"",items:[]},this.isDirty=!1,this.getSettings=()=>this.appRestService.request({method:"GET",url:this.settingUrl}).pipe((0,T.U)(e=>{const r=e.map(d=>({notificationSettingDefinitionId:d.notificationSettingDefinition.id,value:d.notificationSetting.value,isInherited:d.notificationSetting.isInherited,defaultValue:d.notificationSettingDefinition.defaultValue,displayName:d.notificationSettingDefinition.displayName}));return this.originSettings=(0,p.cloneDeep)(r),{tenantId:this.formData.tenantId,items:r}})).pipe((0,g.b)(e=>{this.formData=e})),this.saveSettings=()=>{const e={...this.formData,items:this.formData.items.map(r=>({notificationSettingDefinitionId:r.notificationSettingDefinitionId,value:r.value,isInherited:r.isInherited}))};this.appRestService.request({method:"PUT",url:"/api/app/notification-settings",body:e}).pipe((0,h.w)(()=>this.initConfig())).subscribe(()=>{this.toastService.success("\u5132\u5b58\u6210\u529f!")})}}ngOnInit(){this.initConfig().subscribe()}initConfig(){const n=this.configStateService.getOne("currentUser").tenantId;return n?this.initTenantConfig(n):this.initHostConfig()}initTenantConfig(i){return this.settingUrl="/api/app/notification-settings/current-tenant",this.formData.tenantId=i,this.currentTenantId=i,this.getSettings()}initHostConfig(){return this.appRestService.request({method:"GET",url:"/api/app/notification-settings/assignable-tenants"}).pipe((0,g.b)(i=>{this.formData.tenantId||(this.tenantsDataSource=i.items,this.formData.tenantId=i.items[0]?.id),this.settingUrl=`/api/app/notification-settings/by-tenant-id/${this.formData.tenantId}`})).pipe((0,h.w)(()=>this.getSettings()))}onTenantChanged(i){this.initHostConfig().subscribe()}onSettingValueChanged(){const i=!(0,p.isEqual)(this.originSettings,this.formData.items);this.isDirty=i}static#t=this.\u0275fac=function(n){return new(n||o)(t.Y36(M.$),t.Y36(c.XJE),t.Y36(K.P))};static#i=this.\u0275cmp=t.Xpm({type:o,selectors:[["app-notification-settings"]],viewQuery:function(n,a){if(1&n&&t.Gf(z,5),2&n){let e;t.iGM(e=t.CRH())&&(a.grid=e.first)}},decls:12,vars:11,consts:[[1,"paper-1","d-flex","flex-column","align-items-center","h-100"],[1,"flex-grow-1","d-flex","flex-column","justify-content-center"],[1,"mb-3"],[1,"dx-form-group-caption","text-center","mb-2"],[4,"ngIf"],["appFormFeature","",3,"items","formData"],[4,"dxTemplate","dxTemplateOf"],[1,"d-flex","justify-content-center"],["type","default",3,"text","disabled","onClick"],["displayExpr","name","valueExpr","id",3,"dataSource","value","valueChange","onValueChanged"],[1,"d-flex","align-items-center","mb-3"],[1,"dx-field-item-label-text"],[1,"ps-3","pe-3"],["valueChangeEvent","keyup",3,"value","valueChange","onValueChanged"],["icon","refresh",3,"text","onClick"],["class","d-flex align-items-center mb-3"]],template:function(n,a){1&n&&(t.TgZ(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3),t._uU(4),t.ALo(5,"abpLocalization"),t.qZA(),t.YNc(6,J,2,2,"div",4),t.qZA(),t.TgZ(7,"dx-form",5),t.YNc(8,O,3,0,"div",6),t.qZA()(),t.TgZ(9,"div",7)(10,"dx-button",8),t.NdJ("onClick",function(){return a.saveSettings()}),t.ALo(11,"abpLocalization"),t.qZA()()()),2&n&&(t.xp6(4),t.hij(" ",t.lcZ(5,7,"JBNotifier::Permission:NotificationSettings")," "),t.xp6(2),t.Q6J("ngIf",!a.currentTenantId),t.xp6(),t.Q6J("items",a.formItems)("formData",a.formData),t.xp6(),t.Q6J("dxTemplateOf","notification-setting-definition"),t.xp6(2),t.Q6J("text",t.lcZ(11,9,"AbpUi::Save"))("disabled",!a.isDirty))},dependencies:[m.O5,L,b.K,A.p6,y.Y,_._,Z.I,c.fuE],encapsulation:2})}return o})(),canActivate:[c.a1M,c.nG9]}];let E=(()=>{class o{static#t=this.\u0275fac=function(n){return new(n||o)};static#i=this.\u0275mod=t.oAB({type:o});static#e=this.\u0275inj=t.cJS({imports:[u.Bz.forChild(V),u.Bz]})}return o})();var G=s(5533);let Q=(()=>{class o{static#t=this.\u0275fac=function(n){return new(n||o)};static#i=this.\u0275mod=t.oAB({type:o});static#e=this.\u0275inj=t.cJS({imports:[m.ez,E,v.m,G.P]})}return o})()}}]);